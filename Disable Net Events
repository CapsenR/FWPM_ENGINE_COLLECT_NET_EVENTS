#include "pch.h"
#include <windows.h>
#include <fwpmu.h>
#include <stdio.h>

#pragma comment(lib, "Fwpuclnt.lib")

int main() {
    HANDLE engineHandle = NULL;
    DWORD result;

    // Open a session to the filter engine
    result = FwpmEngineOpen0(
        NULL,                // The server name, NULL for local
        RPC_C_AUTHN_DEFAULT, // Default authentication
        NULL,                // Default authentication service
        NULL,                // Session parameters
        &engineHandle        // Pointer to handle
    );

    if (result != ERROR_SUCCESS) {
        printf("FwpmEngineOpen0 failed with error: %lu\n", result);
        return 1;
    }

    // Set the desired engine option
    FWPM_ENGINE_OPTION option = FWPM_ENGINE_COLLECT_NET_EVENTS;
    FWP_VALUE0 newValue;
    newValue.type = FWP_UINT32;
    newValue.uint32 = 0; // Disable event collection

    result = FwpmEngineSetOption0(engineHandle, option, &newValue);

    if (result != ERROR_SUCCESS) {
        printf("FwpmEngineSetOption0 failed with error: %lu\n", result);
        FwpmEngineClose0(engineHandle);
        return 1;
    }

    printf("FwpmEngineSetOption0 succeeded\n");

    // Close the session to the filter engine
    FwpmEngineClose0(engineHandle);

    return 0;
}
